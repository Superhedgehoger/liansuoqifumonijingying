# 事件系统：类比研究与最小设计

目标：用“少量参数 + 可审计流水”的方式，引入随机扰动，让模拟更像真实经营（天气/事故/舆情/停水停电等），但不把系统复杂度推到不可控。

## 1) 类比研究（3-5 个参考）

| 参考项目 | 事件如何发生 | 事件如何影响经营/系统 | 玩家/运营的可控手段 | 我们可借鉴点 |
|---|---|---|---|---|
| RimWorld Storyteller/Incidents | 由“讲故事器”控制节奏：权重、冷却、适应性 | 直接改变资源/人员/战斗压力 | 预警、准备、应对；难度曲线清晰 | 把事件当“节奏控制器”，用 cooldown 避免连续打击 |
| OpenTTD Disasters | 随机灾害/事故，造成交通中断或资产损毁 | 产能中断、线路被迫重建 | 备份线路、分散风险、紧急修复 | 事件应体现“中断/恢复”，并且持续若干天 |
| Cities: Skylines Disasters | 可开关、可调强度/频率；灾害有范围（区域） | 供电供水中断、道路损坏、服务瘫痪 | 灾害开关/强度；应急服务体系 | 事件要有 scope（global/区域/单点）与强度参数 |
| Frostpunk Events/Laws | 事件常与资源/士气/政策联动，偏“剧情弧线” | 关键指标受影响，导致连锁后果 | 通过政策与分配做权衡 | 事件不必多，但要能在报表里看到因果（审计） |

## 2) 五条设计原则（落到本项目的最小实现）

1) 可控的随机：
- 同一 seed + 同一初始 state + 同一模拟步数 => 结果可复现。
- 随机要“可解释”（发生了什么、影响了哪些门店、持续多久）。

2) 有节奏，不要连环暴击：
- 引入 cooldown（按 template_id + scope + target_id 维度），避免同一目标被连续命中。

3) 作用域清晰：
- global/站点/门店三级 scope，配合 target_strategy（random_one/all）。
- 让运营可以表达“区域性天气” vs “单店事故”。

4) 影响是乘子，不是新系统：
- 以 4 个乘子 + 一个停业开关来表达 80% 的常见扰动：
  - traffic_multiplier
  - conversion_multiplier
  - capacity_multiplier
  - variable_cost_multiplier
  - store_closed

5) 可审计与可回放：
- 每日 store 结果写入 `data/ledger.csv`，包含 multipliers 与 `event_summary_json`。
- state 内保留 event_history（最近若干条），前端可直接展示。

## 3) 本项目当前落地（对应实现）

- 模板：`EventTemplate`（概率、持续、冷却、强度、范围、影响范围）。
- 运行中事件：`ActiveEvent`（start/end、目标、实际倍率、停业）。
- 历史：`EventHistoryRecord`（用于 UI 展示与审计）。
- 事件结算：每天开始 `_events_day_start()`（清理过期、按概率触发、写 history、写 cooldown）。
- 生效方式：门店日结前计算乘子并写入 `DayStoreResult`；停业时订单为 0，固定成本仍计提。
