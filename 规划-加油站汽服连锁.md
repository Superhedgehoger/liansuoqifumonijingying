# 规划：加油站汽服门店（最小升级 + 后续路线图）

面向场景：依托加油站车流，建设汽服门店（自动洗车/人工洗车/综合汽服），以 **盈亏平衡** 为核心目标；客流不做复杂仿真；薪酬体系要与业务强绑定；成本核算要覆盖库存/耗材/折旧/人工等。

相关参考：

- 开源与选型参考：`C:\Users\DJY\Documents\OpencodePJ\连锁汽服经营模拟\开源参考-连锁经营.md`
- 详细最小方案（计算口径/薪酬细化）：`C:\Users\DJY\Documents\OpencodePJ\连锁汽服经营模拟\最小升级方案-加油站汽服.md`

---

## 一、目标与边界

### 目标（先把账算清）

- 能模拟“建设→开业→日结/月结→盈亏平衡→回本期/关停”的闭环
- 利润表与现金流分离（采购/折旧/计提口径清晰）
- 薪酬体系可配置，且与销量/毛利/利润挂钩

### 暂不做（避免复杂度爆炸）

- 省级真实 GIS、复杂客流仿真、竞争门店博弈
- 复杂排班系统（先做固定编制/固定出勤天数换算）
- 综合汽服的完整 SKU/配件仓（先用“材料成本率/单车材料成本”占位）

---

## 二、最小升级方案（v0.2，推荐先做）

范围：**单站点**、可选 **两条洗车业态**（自动洗车 + 人工洗车），综合汽服先占位。

### 2.1 功能清单（闭环必需）

- 站点流量：输入 `加油车辆/日`（访客可选）+ 简单波动
- 服务线：价格、转化率、产能、单笔耗材成本（变动成本）
- 建设期：CAPEX（设备/装修/押金等）+ 建设天数 + 开业状态机
- 折旧：直线法按日计提（设备/装修）
- 库存/耗材（最小）：耗材采购（现金流出）+ 按订单扣减（COGS）
- 薪酬（最小但可用）：
  - 洗车员：底薪（可选）+ 计件 + 阶梯奖
  - 店长：底薪 + 利润/毛利提成（带门槛：利润>0 或过 BEQ 才发）
- 报表：
  - 日报：订单/收入/毛利/人工/折旧/净利润/经营现金流
  - 月报：汇总 + BEQ + 回本期（滚动均值）

### 2.2 核心计算口径（最小实现）

- 订单（按业态）：
  - `potential = fuel_today * conv_fuel + visitor_today * conv_visitor`
  - `orders = min(potential, capacity_per_day)`
- 毛利：`revenue - variable_cost(耗材/水电) - parts_cogs(占位)`
- 利润：`毛利 - 人工(底薪+计件+奖金) - 折旧 - 固定费`
- 现金流：收入入账 vs 采购/发薪/CAPEX 支出分开记
- 盈亏平衡（贡献毛利法）：
  - `unit_contribution = price - variable_cost - variable_labor_per_order`
  - `BEQ_orders = fixed_cost_per_day / unit_contribution`

### 2.3 CLI 最小菜单建议

- 配置站点流量
- 配置服务线
- 采购耗材/查看库存
- 配置薪酬方案
- 配置建设与资产折旧
- 过一天（日结）
- 报表（近 7/30 天、当月、BEQ/回本）

---

## 三、日后规划（路线图）

### v0.3（把“薪酬系统”做完整）

- 引入角色体系：店长/洗车员/技师/前台（可选）
- 计薪规则模板化：
  - 计件（按单/按工时）
  - 销售提成（按收入）
  - 毛利/利润提成（按毛利或经营利润）
  - 阶梯奖金（按销量/毛利/利润阈值）
- 考勤与出勤天数：固定编制→可配置缺勤/加班系数（仍不做复杂排班）
- 薪资报表：人均产出、人工率（人工/收入、人工/毛利）、绩效达标情况

### v0.4（把“综合汽服”跑通）

- 工单/项目：换油/补胎/滤芯等项目表
- 材料成本：从“成本率占位”升级为“项目耗材/配件成本”
- 技师提成：按项目/按工时/按项目毛利提成
- 产能约束：人手→工时→可接单量（把业务与人员规模真正耦合）

### v0.5（多站点/连锁视角，但仍轻量）

- 多站点资产与现金池（总部资金 vs 门店资金口径可选）
- 开店流水线：选点→预算→建设→开业→爬坡（转化率/客单逐步稳定）
- 关店/迁址：沉没成本处理（资产处置、剩余折旧、库存清理）

### v0.6+（需要时再引入的“重能力”）

## 五、当前实现状态（已落地）

- 已完成到 v0.6（轻量版选址/扩张推荐 + 多站点/多门店 + 关店处置 + 综合汽服项目/配件库存 + 薪酬体系）
- WebUI 已提供完整编辑能力：站点、门店属性、服务线、项目目录、薪酬角色、库存采购、资产/折旧、关店处置
- 数据导出与持久化：`data/state.json`（存档）与 `data/ledger.csv`（流水）

- 选址优化：引入 `spopt/MCLP/p-center` 之类做候选点推荐
- 真实地图：`osmnx + networkx` 用路网可达性替代简单半径
- 行为仿真：`mesa` 做顾客选择/分流（仅在你确实要“非加油客流”时再上）

---

## 四、落地优先级（建议）

1) v0.2：把利润表/现金流/折旧/库存耗材/BEQ 跑通（最关键）
2) v0.3：把薪酬体系模板化（你明确要求“详细且与业务挂钩”）
3) v0.4：再把综合汽服按工单做实（引入技师、工时、材料成本）
4) v0.5：最后才做连锁扩张与开关店策略

---

## 六、同类项目补充调研（2026-02）

本次补充参考（开源仓库）：

- `pysal/spopt`：空间优化（MCLP / location-allocation / regionalization）
- `cyang-kth/maximum-coverage-location`：MCLP 最小实现（选点覆盖）
- `projectmesa/mesa`：Agent-Based Simulation（顾客行为、竞争分流）
- `gboeing/osmnx`：OSM 路网与可达性分析（真实路网距离、通达时间）
- `OpenTTD/OpenTTD`：成熟经营模拟的“长期可玩性”机制（事件、版本兼容、可扩展内容）

结合你当前项目（汽服连锁经营模拟）给出的可落地升级点：

1) 选址建议引擎（轻量版）
- 用 MCLP/p-center 在“候选站点 + 客流权重 + 服务半径”上做推荐
- 输出不止“推荐开店列表”，还应给出：覆盖率提升、边际收益、替代方案 A/B

2) 从“直线半径”升级到“路网可达”
- 用 osmnx/networkx 计算通勤时间与可达圈
- 让“同样 3km 半径但道路条件不同”的站点结果可区分

3) 客流分流模型（先半仿真）
- 不必一上来全 ABM，可先做“重力模型/吸引力模型”（距离、价格、口碑、等待时间）
- 第二阶段再接 Mesa，做竞品分流、活动引流、口碑传播

4) 运营实验台（策略 AB 测试）
- 支持并行运行多个策略场景（定价/促销/薪酬/采购/排班）
- 输出统一 KPI 对比（利润、现金流、回本期、风险波动）

5) 更强的可回放与可审计
- 保持“每日账本 + 事件摘要 + 配置快照”三位一体
- 增加“同 seed 可重放”一键验证与结果 diff

---

## 七、当前实现盘点（已做 / 未做）

说明：以下按当前仓库代码与文档状态盘点（v0.7.x 语义）。

### 已做（核心闭环）

- 多站点/多门店模拟，建设期、开业、关店、回退与重置
- 服务线 + 项目组合（project mix）+ 配件/耗材扣减
- 成本核算：变动成本、配件 COGS、折旧、固定费、租金水电、经营利润与净现金流
- 薪酬体系：底薪、分类提成口径、工时提成、月末奖金/分红
- 事件系统 Phase 1：模板、冷却、作用域、手动注入、seed/rng_state、ledger 审计字段、前端事件管理页
- API 已形成“写操作返回全量 state”模式；前端基本运营动作已接通

### 已完成（P1）

- 选址推荐引擎（启发式第一版）已接入：
  - API：`GET /api/site-recommendations?top_k=&radius=`
  - 输出未覆盖需求、最近开店距离、推荐评分
  - 前端：`/strategy` 页面可直接查看推荐列表
- 竞品分流模型已落地（门店参数）：
  - `local_competition_intensity`（0..1）
  - `attractiveness_index`（0.5..1.5）
  - 已接入日订单计算（竞争越强分流越大，吸引力可部分对冲）
- 场景对比实验台（A/B）已实现：
  - API：`POST /api/scenarios/compare`
  - 支持同初始状态并行仿真，不写入真实存档
  - 返回 baseline + scenario 指标与 delta（营收/利润/现金流/日均订单）
  - 前端：`/strategy` 页面可配置并运行 A/B 对比

### 还没做（建议优先级）

P2（中期，已完成）

- 路网可达：已完成 `road_proxy` + `road_graph` + `euclidean` 三种模式（`/api/site-recommendations` + `/strategy`）
- 事件运营对冲：已支持应急供电、临时促销、加班扩容（门店 `mitigation`）
- 自动补货：已支持规则化补货（触发点/安全库存/目标库存/提前期）与在途到货（pending inbounds）

P3（已启动）

- 已完成（P3-Start）：
  - 人力生命周期基础：编制/在岗/培训水平/日流失率/招聘预算与提前期（含在途招聘）
  - 总部融资基础：授信额度、日利率、自动融资与自动还款
  - BI 预警基础：现金、授信占用、人手缺口、低于安全库存预警
- 待完成（P3-Next）：
  - 细化排班与班次、请假、岗位技能矩阵
  - 预算与融资扩展：分期 CAPEX、融资成本归集、滚动预算
  - BI 看板深化：区域/业态/角色的人效钻取与趋势分析
